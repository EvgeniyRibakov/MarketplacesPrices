# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: Fallback –Ω–∞ Playwright –ø—Ä–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ curl_cffi

## üîç Root Cause Analysis

### –ü—Ä–æ–±–ª–µ–º–∞
Ozon –∞–Ω—Ç–∏–±–æ—Ç –±–ª–æ–∫–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å—ã —á–µ—Ä–µ–∑ `curl_cffi`, –¥–∞–∂–µ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ cookies (12 cookies –ø–æ–ª—É—á–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ).

### –î–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞ –∏–∑ –ª–æ–≥–æ–≤
1. **–°—Ç—Ä–æ–∫–∞ 20**: Playwright —É—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–∞–µ—Ç **200 OK** –æ—Ç entrypoint API
2. **–°—Ç—Ä–æ–∫–∞ 92**: curl_cffi —Å —Ç–µ–º–∏ –∂–µ cookies –ø–æ–ª—É—á–∞–µ—Ç **403 Forbidden** —Å `ozon-antibot: 1`
3. **–°—Ç—Ä–æ–∫–∞ 206**: –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ —á–µ—Ä–µ–∑ curl_cffi —Ç–∞–∫–∂–µ –ø–æ–ª—É—á–∞–µ—Ç 403

### –í—ã–≤–æ–¥
**–ü—Ä–æ–±–ª–µ–º–∞ –ù–ï –≤ cookies** (–∏—Ö –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ - 12 —à—Ç—É–∫), –∞ –≤ —Ç–æ–º, —á—Ç–æ **Ozon –¥–µ—Ç–µ–∫—Ç–∏—Ä—É–µ—Ç curl_cffi –∫–∞–∫ –±–æ—Ç** –Ω–∞ —É—Ä–æ–≤–Ω–µ TLS fingerprint –∏–ª–∏ –¥—Ä—É–≥–∏—Ö —Å–∏–≥–Ω–∞–ª–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –∑–∞–≤–∏—Å—è—Ç –æ—Ç cookies.

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### –°—Ç—Ä–∞—Ç–µ–≥–∏—è: –ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–¥—Ö–æ–¥ —Å fallback
–í–º–µ—Å—Ç–æ –ø–æ–ª–Ω–æ–π –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã (–∫–∞–∫ –ø—Ä–µ–¥–ª–∞–≥–∞–ª DeepSeek), –¥–æ–±–∞–≤–ª–µ–Ω **–º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π fallback –Ω–∞ Playwright** –ø—Ä–∏ –ø–µ—Ä–≤–æ–π –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ curl_cffi.

### –ß—Ç–æ –∏–∑–º–µ–Ω–µ–Ω–æ

#### 1. –ù–æ–≤—ã–π –º–µ—Ç–æ–¥ `_fetch_page_via_playwright` (—Å—Ç—Ä–æ–∫–∏ 402-477)
- –í—ã–ø–æ–ª–Ω—è–µ—Ç –∑–∞–ø—Ä–æ—Å –∫ entrypoint API —á–µ—Ä–µ–∑ Playwright
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–µ –∂–µ cookies –∏ –∑–∞–≥–æ–ª–æ–≤–∫–∏
- –ü—Ä–∏–º–µ–Ω—è–µ—Ç stealth –ø–ª–∞–≥–∏–Ω –¥–ª—è –æ–±—Ö–æ–¥–∞ –∞–Ω—Ç–∏–±–æ—Ç–æ–≤
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç JSON –¥–∞–Ω–Ω—ã–µ –∏–ª–∏ None

#### 2. –û–±–Ω–æ–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ 403 –æ—à–∏–±–∫–∏ (—Å—Ç—Ä–æ–∫–∏ 759-777)
**–ë—ã–ª–æ:**
```python
if retry_count == 0:
    # –û–±–Ω–æ–≤–ª—è–µ–º cookies –∏ –ø–æ–≤—Ç–æ—Ä—è–µ–º —á–µ—Ä–µ–∑ curl_cffi
    await self._initialize_session()
    return await self._fetch_page(..., retry_count + 1)
```

**–°—Ç–∞–ª–æ:**
```python
if retry_count == 0:
    # –ü—Ä–æ–±—É–µ–º fallback –Ω–∞ Playwright (–æ–Ω —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ—Ö–æ–¥–∏—Ç –∞–Ω—Ç–∏–±–æ—Ç)
    playwright_result = await self._fetch_page_via_playwright(url, seller_name, seller_id)
    if playwright_result:
        return playwright_result
    
    # –ï—Å–ª–∏ Playwright –Ω–µ –ø–æ–º–æ–≥, –ø—Ä–æ–±—É–µ–º –æ–±–Ω–æ–≤–∏—Ç—å cookies
    await self._initialize_session()
    return await self._fetch_page(..., retry_count + 1)
```

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —Ä–µ—à–µ–Ω–∏—è
1. ‚úÖ **–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è** - –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∏ –≤—Å–µ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã
2. ‚úÖ **–ë—ã—Å—Ç—Ä–æ–µ —Ä–µ—à–µ–Ω–∏–µ** - Playwright —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
3. ‚úÖ **–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ—Å—Ç—å** - —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –ª—é–±–æ–º –ü–ö –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
4. ‚úÖ **–û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å** - curl_cffi –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, Playwright —Ç–æ–ª—å–∫–æ –∫–∞–∫ fallback
5. ‚úÖ **–î–æ–∫–∞–∑–∞–Ω–Ω–∞—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å** - Playwright —É–∂–µ —É—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–∞–µ—Ç 200 OK –≤ –ª–æ–≥–∞—Ö

## üìä –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
```
curl_cffi ‚Üí 403 Forbidden (ozon-antibot: 1)
retry curl_cffi ‚Üí 403 Forbidden (ozon-antibot: 1)
‚Üí OzonAntibotException
```

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
```
curl_cffi ‚Üí 403 Forbidden (ozon-antibot: 1)
Playwright fallback ‚Üí 200 OK ‚úÖ
‚Üí –£—Å–ø–µ—à–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
```

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –ú–µ—Ç–æ–¥ `_fetch_page_via_playwright`
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `playwright.async_api` –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤
- –ü—Ä–∏–º–µ–Ω—è–µ—Ç `playwright-stealth` –¥–ª—è –æ–±—Ö–æ–¥–∞ –∞–Ω—Ç–∏–±–æ—Ç–æ–≤
- –û—Ç–∫—Ä—ã–≤–∞–µ—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø—Ä–æ–¥–∞–≤—Ü–∞ –ø–µ—Ä–µ–¥ API –∑–∞–ø—Ä–æ—Å–æ–º (–¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ cookies)
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–µ –∂–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏, —á—Ç–æ –∏ curl_cffi

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- –ï—Å–ª–∏ Playwright –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω ‚Üí fallback –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –ø—Ä–æ–±—É–µ–º –æ–±–Ω–æ–≤–∏—Ç—å cookies
- –ï—Å–ª–∏ Playwright –≤–µ—Ä–Ω—É–ª –Ω–µ 200 ‚Üí –ø—Ä–æ–±—É–µ–º –æ–±–Ω–æ–≤–∏—Ç—å cookies –∏ retry —á–µ—Ä–µ–∑ curl_cffi
- –ï—Å–ª–∏ Playwright —É—Å–ø–µ—à–µ–Ω ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ

## üìù –§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω—ã
- `src/api/ozon_catalog_api.py`:
  - –î–æ–±–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ `_fetch_page_via_playwright` (—Å—Ç—Ä–æ–∫–∏ 402-477)
  - –û–±–Ω–æ–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ 403 –æ—à–∏–±–∫–∏ (—Å—Ç—Ä–æ–∫–∏ 759-777)

## üöÄ –ß—Ç–æ –¥–µ–ª–∞—Ç—å –¥–∞–ª—å—à–µ

1. **–ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–∞—Ä—Å–∏–Ω–≥** - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ Playwright fallback —Ä–∞–±–æ—Ç–∞–µ—Ç
2. **–ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å –ª–æ–≥–∏** - —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ fallback —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∏ —É—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ
3. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)**:
   - –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ Playwright –±—Ä–∞—É–∑–µ—Ä–∞ –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è
   - –ú–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å Playwright –æ—Å–Ω–æ–≤–Ω—ã–º –º–µ—Ç–æ–¥–æ–º, –µ—Å–ª–∏ curl_cffi –≤—Å–µ–≥–¥–∞ –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **Playwright –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω**: `pip install playwright playwright-stealth && playwright install chromium`
2. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: Playwright –º–µ–¥–ª–µ–Ω–Ω–µ–µ curl_cffi, –Ω–æ —ç—Ç–æ –∫–æ–º–ø—Ä–æ–º–∏—Å—Å –¥–ª—è –æ–±—Ö–æ–¥–∞ –∞–Ω—Ç–∏–±–æ—Ç–∞
3. **–†–µ—Å—É—Ä—Å—ã**: Playwright –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –±–æ–ª—å—à–µ –ø–∞–º—è—Ç–∏ (–∑–∞–ø—É—Å–∫–∞–µ—Ç –±—Ä–∞—É–∑–µ—Ä)
