# –ê–Ω–∞–ª–∏–∑ –æ—à–∏–±–∫–∏ 403 –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

## üîç –ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞ (Root Cause)

### –ü—Ä–æ–±–ª–µ–º–∞ #1: –û—à–∏–±–∫–∞ Playwright `'module' object is not callable`
**–°—Ç—Ä–æ–∫–∞ –∫–æ–¥–∞:** `src/utils/playwright_cookies.py:54`
**–û—à–∏–±–∫–∞ –≤ –ª–æ–≥–µ:** –°—Ç—Ä–æ–∫–∞ 14

**–ü—Ä–∏—á–∏–Ω–∞:**
- –§—É–Ω–∫—Ü–∏—è `stealth` –∏–∑ `playwright-stealth` –º–æ–∂–µ—Ç –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è –∫–∞–∫ –º–æ–¥—É–ª—å, –∞ –Ω–µ —Ñ—É–Ω–∫—Ü–∏—è
- –í—ã–∑–æ–≤ `stealth(page)` –≤—ã–∑—ã–≤–∞–µ—Ç –æ—à–∏–±–∫—É, –µ—Å–ª–∏ `stealth` - —ç—Ç–æ –º–æ–¥—É–ª—å

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ `callable(stealth)` –ø–µ—Ä–µ–¥ –≤—ã–∑–æ–≤–æ–º
- –û–±–µ—Ä–Ω—É—Ç–æ –≤ try-except –¥–ª—è graceful fallback
- –ï—Å–ª–∏ stealth –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –±–µ–∑ –Ω–µ–≥–æ (–Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ)

---

### –ü—Ä–æ–±–ª–µ–º–∞ #2: –ù–µ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –ª–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ `ozon-antibot` header
**–°—Ç—Ä–æ–∫–∞ –∫–æ–¥–∞:** `src/api/ozon_catalog_api.py:627-676`
**–û—à–∏–±–∫–∞ –≤ –ª–æ–≥–µ:** –°—Ç—Ä–æ–∫–∏ 118, 213 - –µ—Å—Ç—å `ozon-antibot: 1`, –Ω–æ –Ω–µ—Ç –≤—ã–±—Ä–æ—Å–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏—è

**–ü—Ä–∏—á–∏–Ω–∞:**
- –ö–æ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–∏ 403 –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–ª –Ω–∞–ª–∏—á–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞ `ozon-antibot`
- –ù–µ –±—ã–ª–æ –≤—ã–±—Ä–æ—Å–∞ `OzonAntibotException` –ø–æ—Å–ª–µ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫
- –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–ª–∞—Å—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ proxy –≤ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–µ

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ `'ozon-antibot' in response_headers`
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω —Å—á–µ—Ç—á–∏–∫ `_antibot_triggered_count`
- ‚úÖ –í—ã–±—Ä–æ—Å `OzonAntibotException` –ø–æ—Å–ª–µ retry —Å –∞–∫—Ç–∏–≤–Ω—ã–º –∞–Ω—Ç–∏–±–æ—Ç–æ–º
- ‚úÖ –ü–æ–∫–∞–∑ proxy –≤ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–µ: `Proxy: {self.proxy if self.proxy else '–ù–ï –ò–°–ü–û–õ–¨–ó–£–ï–¢–°–Ø'}`
- ‚úÖ –í—ã–∑–æ–≤ `_log_cookies_diagnostic()` –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
- ‚úÖ –£–≤–µ–ª–∏—á–µ–Ω–∞ –∑–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ retry: 2.0 ‚Üí 5.0 —Å–µ–∫

---

## üìã –ß—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

### 1. `src/utils/playwright_cookies.py`
```python
# –ë–´–õ–û:
stealth(page)

# –°–¢–ê–õ–û:
try:
    if callable(stealth):
        stealth(page)
    else:
        logger.warning("‚ö†Ô∏è stealth –Ω–µ —è–≤–ª—è–µ—Ç—Å—è —Ñ—É–Ω–∫—Ü–∏–µ–π, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ")
except Exception as e:
    logger.warning(f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–∏–º–µ–Ω–∏—Ç—å stealth –ø–ª–∞–≥–∏–Ω: {e}. –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –±–µ–∑ –Ω–µ–≥–æ...")
```

### 2. `src/api/ozon_catalog_api.py` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ 403
```python
# –î–û–ë–ê–í–õ–ï–ù–û:
- –ü—Ä–æ–≤–µ—Ä–∫–∞ ozon-antibot header
- –°—á–µ—Ç—á–∏–∫ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–π –∞–Ω—Ç–∏–±–æ—Ç–∞
- –í—ã–±—Ä–æ—Å OzonAntibotException
- –ü–æ–∫–∞–∑ proxy –≤ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–µ
- –í—ã–∑–æ–≤ _log_cookies_diagnostic()
- –£–≤–µ–ª–∏—á–µ–Ω–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ retry (5 —Å–µ–∫)
```

---

## üéØ –û–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### –ü—Ä–∏ –ø–µ—Ä–≤–æ–π 403 –æ—à–∏–±–∫–µ:
```
‚ö†Ô∏è Forbidden (403) –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã 1...
üîç –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê 403 –û–®–ò–ë–ö–ò:
  ‚Ä¢ Antibot header: –î–ê (ozon-antibot: 1)
  ‚Ä¢ –í—Å–µ–≥–æ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–π –∞–Ω—Ç–∏–±–æ—Ç–∞: 1
  ‚Ä¢ Proxy: –ù–ï –ò–°–ü–û–õ–¨–ó–£–ï–¢–°–Ø  ‚Üê –¢–ï–ü–ï–†–¨ –ü–û–ö–ê–ó–´–í–ê–ï–¢–°–Ø
üîç –î–µ—Ç–∞–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ cookies:  ‚Üê –¢–ï–ü–ï–†–¨ –í–´–ó–´–í–ê–ï–¢–°–Ø
  ‚Ä¢ –ò—Å—Ç–æ—á–Ω–∏–∫ cookies: –ë—Ä–∞—É–∑–µ—Ä (auto)
  ‚Ä¢ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ cookies: 2
  ...
  ‚Ä¢ –ü–æ–ø—ã—Ç–∫–∞ –æ–±–Ω–æ–≤–∏—Ç—å cookies...
```

### –ü—Ä–∏ –≤—Ç–æ—Ä–æ–π 403 –æ—à–∏–±–∫–µ (–ø–æ—Å–ª–µ retry):
```
üö´ Ozon antibot –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω (–ø–æ–ø—ã—Ç–∫–∞ 2/2 –≤—Å–µ–≥–æ)
‚ùå OzonAntibotException: Ozon antibot –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –¥–æ—Å—Ç—É–ø –ø–æ—Å–ª–µ 2 –ø–æ–ø—ã—Ç–æ–∫...
  –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:
    ‚Ä¢ –°–¥–µ–ª–∞–π—Ç–µ –ø–∞—É–∑—É 5-10 –º–∏–Ω—É—Ç
    ‚Ä¢ –°–º–µ–Ω–∏—Ç–µ IP –∞–¥—Ä–µ—Å (VPN/proxy)
    ‚Ä¢ –£–º–µ–Ω—å—à–∏—Ç–µ —á–∞—Å—Ç–æ—Ç—É –∑–∞–ø—Ä–æ—Å–æ–≤
    ‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ headless=False –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
```

---

## üß™ –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è Playwright:
```bash
python parse_ozon_sellers.py
# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å: "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–∏–º–µ–Ω–∏—Ç—å stealth –ø–ª–∞–≥–∏–Ω" –≤–º–µ—Å—Ç–æ –æ—à–∏–±–∫–∏
# –ò–ª–∏ —É—Å–ø–µ—à–Ω–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –±–µ–∑ –æ—à–∏–±–æ–∫
```

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ 403:
```bash
python parse_ozon_sellers.py
# –í –ª–æ–≥–∞—Ö –¥–æ–ª–∂–Ω–æ –ø–æ—è–≤–∏—Ç—å—Å—è:
# - "Antibot header: –î–ê"
# - "Proxy: –ù–ï –ò–°–ü–û–õ–¨–ó–£–ï–¢–°–Ø" (–∏–ª–∏ –∞–¥—Ä–µ—Å proxy)
# - "üîç –î–µ—Ç–∞–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ cookies"
# - –ü—Ä–∏ –≤—Ç–æ—Ä–æ–π –ø–æ–ø—ã—Ç–∫–µ: OzonAntibotException
```

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å proxy (–µ—Å–ª–∏ –µ—Å—Ç—å):
```env
# –í .env
OZON_PROXY=http://your-proxy:8080
```

–í –ª–æ–≥–∞—Ö –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å: `Proxy: http://your-proxy:8080`

---

## üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –¥–æ/–ø–æ—Å–ª–µ

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –î–æ | –ü–æ—Å–ª–µ |
|----------|-----|---------|
| –û—à–∏–±–∫–∞ Playwright | ‚ùå `'module' object is not callable` | ‚úÖ Graceful fallback |
| –ü—Ä–æ–≤–µ—Ä–∫–∞ ozon-antibot | ‚ùå –ù–µ—Ç | ‚úÖ –ï—Å—Ç—å |
| –í—ã–±—Ä–æ—Å –∏—Å–∫–ª—é—á–µ–Ω–∏—è | ‚ùå –ù–µ—Ç | ‚úÖ –ü–æ—Å–ª–µ retry |
| –ü–æ–∫–∞–∑ proxy | ‚ùå –ù–µ—Ç | ‚úÖ –í –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–µ |
| –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ cookies | ‚ùå –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è | ‚úÖ –ü–æ–¥—Ä–æ–±–Ω–∞—è |
| –ó–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ retry | 2 —Å–µ–∫ | 5 —Å–µ–∫ |

---

## ‚ö†Ô∏è –ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –æ—Å—Ç–∞–Ω–µ—Ç—Å—è

–ï—Å–ª–∏ –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π –≤—Å–µ –µ—â–µ –±—É–¥–µ—Ç 403:

1. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ proxy –ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω** (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ)
2. **–ü–æ–ø—Ä–æ–±—É–π—Ç–µ headless=False** –¥–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–π –æ—Ç–ª–∞–¥–∫–∏
3. **–£–≤–µ–ª–∏—á—å—Ç–µ –∑–∞–¥–µ—Ä–∂–∫–∏** –¥–æ 10-15 —Å–µ–∫—É–Ω–¥
4. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ VPN** –¥–ª—è —Å–º–µ–Ω—ã IP
5. **–†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ DeepSeek –ø–æ–¥—Ö–æ–¥** - –ø–æ–ª–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ Playwright –¥–ª—è –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
