# Архитектурное ревью идей для парсера Ozon

**Дата создания:** 2026-01-21  
**Цель:** Анализ идей от нескольких ИИ-источников в контексте текущего проекта

---

## Приоритеты проекта (по убыванию важности)

1. **Простота запуска на разных ПК**
2. **Простота и стабильность хостинга (Railway / VPS)**
3. **Скорость парсинга**
4. **Поддерживаемость кода**
5. **Разумная устойчивость к антиботу (не максимальная)**

---

## Ограничения проекта

- ❌ Playwright НЕ является допустимой runtime-зависимостью
- ❌ Браузерные решения допустимы только как dev-инструменты
- ✅ Предпочтение HTTP-only архитектуре
- ✅ Проект — Python, без enterprise-инфраструктуры

---

## 1. Анализ идей по ИИ-источникам

### ИИ №1: ChatGPT Thinking (фокус на HTTP-only и режимы)

| № | Идея | Кратко | Применимость | Оценка /10 | Аргументация |
|---|------|--------|--------------|------------|--------------|
| 1 | Разделить проект на 2 режима: `local/server/fast/safe` | Режимы через .env: MODE=local/server/fast/safe | ✅ подходит | **9/10** | **Отлично подходит под приоритет №1 (простота запуска).** Позволяет одним кодом работать на ПК и хостинге. Текущий код уже имеет request_delay в коде — вынести в режимы логично. Минус: нужна документация для каждого режима. |
| 2 | Cookies-as-a-Service (получение 1 раз локально) | Локально добываешь cookies → сохраняешь → используешь везде | ✅ подходит | **10/10** | **Идеальное решение для приоритета №2 (хостинг).** Playwright вообще не нужен на сервере. Уже есть механизм получения cookies — просто добавить сохранение в файл. Полностью соответствует ограничению "браузеры только для dev". |
| 3 | Убрать Playwright из runtime, оставить в dev-tools | requirements.txt без Playwright | ✅ подходит | **10/10** | **Критически важно для хостинга.** Текущий Docker образ будет в 3-5 раз легче. Railway/VPS деплой станет тривиальным. Playwright → requirements-dev.txt. |
| 4 | Параллельная пагинация + adaptive delay | Загрузка 3-5 страниц параллельно с jitter | ✅ подходит | **8/10** | **Хорошо для приоритета №3 (скорость).** Но: логи показывают 100% 403 на curl_cffi, значит параллелизм сейчас не поможет. Сначала надо решить проблему антибота. |
| 5 | Кэш страниц каталога (.cache/ директория) | Кэшировать JSON страниц на 24 часа | ✅ подходит | **7/10** | **Хорошо для отладки и повторных запусков.** Но: каталоги продавцов меняются часто (цены, акции). Нужен механизм инвалидации кэша. Для production-хостинга может быть проблемой (место на диске). |
| 6 | CLI с Click: `python run.py fast/safe/server` | Preset-ы параметров через CLI | ⚠️ подходит с доработками | **6/10** | **Упрощает UX, но:** текущий проект уже имеет argparse в parse_ozon_sellers.py. Добавление Click — лишняя зависимость. Можно реализовать preset-ы через .env без новой библиотеки. |

**Общая оценка блока:** Очень сильные идеи, точно попадающие в приоритеты. Особенно №2 и №3 (Cookies-as-a-Service и убирание Playwright) — это ключевые для хостинга.

---

### ИИ №2: ChatGPT Research (официальные API и инфраструктура)

| № | Идея | Кратко | Применимость | Оценка /10 | Аргументация |
|---|------|--------|--------------|------------|--------------|
| 1 | Использование официальных API вместо парсинга | Уточнить у Ozon дополнительные API-методы | ❌ не подходит | **2/10** | **Не реалистично.** Ozon не предоставит больше API методов для конкурентного анализа. Seller API уже используется, он возвращает 0 товаров из-за несовпадения аккаунта (товары чужого продавца). Идея теоретически правильная, практически бесполезная. |
| 2 | Ротация прокси и IP | Использовать пул прокси для распределения запросов | ⚠️ подходит с доработками | **5/10** | **Конфликтует с приоритетом №1 (простота).** Прокси = дополнительные деньги, настройка, точка отказа. Для локального ПК не подходит. Для хостинга — возможно, но резидентные прокси дорогие (от $50/мес). |
| 3 | Ротация заголовков и User-Agent | Меняйте UA с каждой сессией через fake_useragent | ⚠️ подходит с доработками | **6/10** | **Помогает антиботу, но частично.** Логи показывают, что curl_cffi с правильным UA всё равно блокируется. TLS fingerprint важнее. Можно добавить, но это не решит основную проблему. |
| 4 | Кэширование ответов на диск | Сохранять JSON/SKU на диск | ✅ подходит | **7/10** | **То же, что идея №5 от ChatGPT Thinking.** Хорошо для dev, но нужен механизм инвалидации. |
| 5 | Валидация артикулов продавца (Seller API) | Проверить права доступа, спарсить из HTML как fallback | ✅ подходит | **8/10** | **Решает реальную проблему (0 товаров из Seller API).** Текущая архитектура показывает: товары НЕ принадлежат продавцу по Client ID. Fallback на HTML-парсинг offer_id — хорошая идея, но это браузерный парсинг → конфликтует с HTTP-only. |
| 6 | Улучшение сбора SKU (все widgetStates) | Расширить парсинг JSON на все форматы виджетов | ⚠️ подходит с доработками | **5/10** | **Возможно, но:** текущий парсер уже собирает 524 товара (100%). Нет признаков пропущенных товаров. Решение в поиске проблемы. |
| 7 | Асинхронность через asyncio.gather | Параллельные задачи для страниц | ✅ подходит | **8/10** | **Уже частично реализовано (max_concurrent=3).** Можно улучшить через явный asyncio.gather вместо семафора. Хорошо для скорости. |
| 8 | Ускоренный JSON через orjson | Заменить json.loads() на orjson.loads() | ✅ подходит | **6/10** | **Микрооптимизация.** Время парсинга = ~2% от общего (по метрикам). Даже 10x ускорение даст +0.2% к общему времени. Не критично. |
| 9 | Батчинг Seller API (по 1000 SKU) | Запросы большими пачками | ✅ подходит | **4/10** | **Уже используется (524 SKU за раз).** Но Seller API возвращает 0, так что оптимизация бессмысленна до фикса API. |
| 10 | Случайные задержки и "человеческое" поведение | Рандомные паузы, движения мыши в Playwright | ⚠️ подходит с доработками | **4/10** | **Конфликтует с целью убрать Playwright из runtime.** Если Playwright только dev-tool, то эта идея не применима для production. |
| 11 | Тщательная TLS-эмуляция (curl_cffi impersonate) | Используйте Chrome 131 или новее | ✅ подходит | **7/10** | **Уже используется (impersonate="chrome131").** Но логи показывают 100% 403. Значит, TLS-эмуляция curl_cffi недостаточна для Ozon. Можно попробовать chrome_stable или chrome132. |
| 12 | Двухуровневая стратегия (curl_cffi → Playwright) | Уже реализована | ✅ подходит | **9/10** | **Уже есть в проекте.** Работает идеально (100% fallback успешны). Но конфликтует с целью убрать Playwright. Нужна другая стратегия. |
| 13 | Использование прокси в обходе антибота | Резидентные прокси + Playwright | ⚠️ подходит с доработками | **5/10** | **То же, что идея №2.** Дорого, сложно. |
| 14 | Мониторинг блокировок (авто-увеличение delay) | Счётчик 403 → адаптивная задержка | ✅ подходит | **8/10** | **Отличная идея для production.** Можно реализовать как простой PID-контроллер. Соответствует приоритету №4 (поддерживаемость). |
| 15 | Плавное увеличение скорости (тестирование настроек) | Постепенно снижать delay, мониторить 403 | ✅ подходит | **7/10** | **Хороший подход, но:** текущие настройки уже оптимизированы (delay=1.0, concurrent=3). Дальнейшее ускорение = высокий риск. |
| 16 | Кэширование cookies на диск | Переиспользование cookies между запусками | ✅ подходит | **10/10** | **То же, что Cookies-as-a-Service от ChatGPT Thinking.** Критически важно. |
| 17 | Параллельная обработка (несколько потоков/процессов) | Распределить страницы по потокам | ⚠️ подходит с доработками | **5/10** | **Сложно + GIL в Python.** Текущий async подход лучше. Multiprocessing усложнит код без явных преимуществ. |
| 18 | Оптимизация вывода (CSV вместо Excel) | БД или CSV для больших объёмов | ⚠️ подходит с доработками | **5/10** | **Время экспорта = 1.77 сек (0.45%).** Не бутылочное горлышко. Но для хостинга БД может быть удобнее Excel. |

**Общая оценка блока:** Много идей, но большинство либо уже реализованы, либо конфликтуют с приоритетами. Сильные: №14 (мониторинг), №16 (кэш cookies), №7 (asyncio.gather).

---

### ИИ №3: Grok (3 ответа) - Хостинг и простота

#### Grok ответ 3.1 (фокус на скорость, простота, хостинг)

| № | Идея | Кратко | Применимость | Оценка /10 | Аргументация |
|---|------|--------|--------------|------------|--------------|
| 1 | Распределенная обработка с Celery/Ray | Task queue для параллельного парсинга | ❌ не подходит | **3/10** | **Конфликтует с приоритетом №1 (простота).** Celery требует Redis/RabbitMQ, Ray — сложная настройка. Проект станет enterprise-уровня. Для 500 товаров это overkill. |
| 2 | Headless cloud browsers (Browserless.io, Puppeteer в Lambda) | API вместо локального Playwright | ⚠️ подходит с доработками | **6/10** | **Хорошая идея для хостинга, НО:** дополнительные расходы ($20-100/мес), внешняя зависимость. Конфликтует с целью "простота". Для production может быть полезно. |
| 3 | GPU-accelerated парсинг с Dask | Distributed data processing на GPU | ❌ не подходит | **1/10** | **Абсурд для парсинга.** GPU для парсинга JSON? Парсинг = 2% времени. Это enterprise-подход для ML, не для парсера. Полностью не подходит. |
| 4 | Dockerization проекта | Всё в Docker container | ✅ подходит | **9/10** | **Критически важно для приоритета №2 (хостинг).** Уже есть зачатки (упоминается в идеях). Нужен качественный Dockerfile без Playwright в base image. |
| 5 | CLI с Click или Typer | `python main.py --seller-id 176640 --mode fast` | ⚠️ подходит с доработками | **6/10** | **То же, что ChatGPT Thinking.** Лишняя зависимость. Можно через argparse (уже есть). |
| 6 | No-code GUI с Streamlit | Web-интерфейс для запуска | ❌ не подходит | **4/10** | **Конфликтует с "простота запуска на ПК".** Streamlit требует запуск веб-сервера. Для локального ПК это усложнение. Для хостинга — возможно, но не приоритет. |
| 7 | Serverless deploy (Lambda/Cloud Run) | Docker → AWS Lambda с API | ⚠️ подходит с доработками | **7/10** | **Хорошо для хостинга, НО:** Lambda имеет лимит 15 минут (текущий парсинг = 6.5 мин). Для больших каталогов не подойдёт. Cloud Run лучше (60 мин лимит). |
| 8 | Kubernetes для хостинга | Deploy как pod в K8s | ❌ не подходит | **2/10** | **Enterprise overkill.** Для одного парсера K8s — это как из пушки по воробьям. Конфликтует с "простота". |
| 9 | Хостинг как SaaS (Vercel/Heroku + FastAPI) | API wrapper вокруг парсера | ⚠️ подходит с доработками | **6/10** | **Интересная идея для монетизации, но:** выходит за рамки текущего проекта. Vercel имеет лимит 10 сек для edge functions. Не подходит. |

**Общая оценка блока 3.1:** Много "креативных" идей, но большинство — enterprise-подходы. Единственная сильная идея — Docker (#4). Остальное конфликтует с простотой.

#### Grok ответ 3.2 (анализ текущего проекта)

| № | Идея | Кратко | Применимость | Оценка /10 | Аргументация |
|---|------|--------|--------------|------------|--------------|
| 1 | Проверка и расширение Seller API | Валидация Client-ID, fallback на HTML парсинг | ✅ подходит | **8/10** | **Решает проблему 0 товаров.** Но HTML fallback = браузер. Можно добавить диагностику: если 0 результатов → логировать и пропускать Seller API. |
| 2 | Интеграция альтернативных источников (Performance API) | Использовать другие методы Ozon API | ⚠️ подходит с доработками | **5/10** | **Теоретически правильно, но:** Performance API скорее всего не даст данных для чужого продавца. Нужна проверка. |
| 3 | ML для предсказания seller_price | Regression на исторических данных | ❌ не подходит | **2/10** | **Overkill и ненадёжно.** Цены продавца != цены покупателя. Модель будет неточной. Лучше признать, что данных нет. |
| 4 | Ротация proxies и user-agents | Rotating proxies + random UA | ⚠️ подходит с доработками | **5/10** | **То же, что раньше.** Прокси = сложность + деньги. |
| 5 | Улучшить Playwright (переиспользование контекста) | Один browser instance для всех запросов | ✅ подходит | **8/10** | **Отличная идея для оптимизации Playwright fallback.** Сократит время с 5-10 сек до 2-3 сек. Но конфликтует с целью убрать Playwright из runtime. |
| 6 | AI для предсказания блокировок | ML-модель на логах для предсказания 403 | ❌ не подходит | **1/10** | **Абсурд.** Антибот Ozon непредсказуем. Модель будет бесполезной. Enterprise overkill. |
| 7 | Полная asyncio для парсера | Расширить aiohttp на всё | ✅ подходит | **8/10** | **То же, что ChatGPT Research.** Хорошая идея. |
| 8 | Кэширование с Redis | Incremental updates | ⚠️ подходит с доработками | **5/10** | **Redis = дополнительная зависимость.** Для локального ПК не подходит. Для хостинга — возможно. Но diskcache (Python) проще. |
| 9 | Cloud deployment serverless | AWS Lambda / Google Cloud Run | ⚠️ подходит с доработками | **7/10** | **То же, что идея №7 из 3.1.** |
| 10 | Alerting system (Slack/Email) | Оповещения на >50% fallback | ⚠️ подходит с доработками | **6/10** | **Хорошо для production хостинга, но:** усложняет настройку. Не для локального ПК. |
| 11 | Визуализация в dashboard (Kibana/Streamlit) | Графики скидок, trends | ❌ не подходит | **3/10** | **Выходит за рамки парсера.** Это уже BI-инструмент. Конфликтует с простотой. |
| 12 | Competitor analysis (несколько продавцов) | Расширить на парсинг конкурентов | ⚠️ подходит с доработками | **6/10** | **Хорошая идея для будущего, но:** сейчас даже один продавец парсится 6.5 минут. Сначала надо ускорить. |

**Общая оценка блока 3.2:** Хорошая диагностика текущих проблем, но идеи либо повторяют предыдущие, либо слишком сложные.

---

### ИИ №4: Deepseek (2 ответа) - Параллельный парсинг и режимы

#### Deepseek ответ 4.1 (практичные решения)

| № | Идея | Кратко | Применимость | Оценка /10 | Аргументация |
|---|------|--------|--------------|------------|--------------|
| 1 | Разделение на режимы (Fast/Reliable/Debug) | LocalFastParser / ServerOptimizedParser | ✅ подходит | **9/10** | **То же, что ChatGPT Thinking, но с конкретной реализацией.** Отлично подходит. LocalFastParser = Playwright пул, ServerOptimizedParser = HTTP-only. |
| 2 | Локальный режим с пулом браузеров | BrowserPool(size=5) для параллельных браузеров | ⚠️ подходит с доработками | **6/10** | **Хорошо для скорости, но:** 5 браузеров Playwright = огромное потребление RAM (~1-2 GB каждый). Для локального ПК может быть проблемой. Для сервера с 16+ GB RAM — нормально. |
| 3 | Параллельный парсинг всех страниц | asyncio.create_task для 44 страниц сразу | ✅ подходит | **8/10** | **Хорошая идея, но:** текущий код показывает 100% 403 на curl_cffi. Параллелизм поможет только если антибот будет пропускать запросы. Сначала надо фиксить антибот. |
| 4 | Smart-cache с TTLCache | Кэш в памяти на 1 час | ✅ подходит | **7/10** | **Хорошо для dev и повторных запусков.** TTLCache = простая реализация. Но для production нужен diskcache (переживает перезапуски). |
| 5 | Headless Chromium с оптимизациями | Оптимизированные args для Playwright | ✅ подходит | **7/10** | **Хорошая идея для ускорения Playwright fallback.** Но конфликтует с целью убрать Playwright из runtime. |
| 6 | Предварительная загрузка данных | Быстрая оценка товаров → параллельная загрузка SKU | ⚠️ подходит с доработками | **6/10** | **Интересная оптимизация, но:** текущая архитектура уже загружает страницы последовательно. Для реализации нужен рефакторинг. Средний приоритет. |
| 7 | Интеллектуальные задержки (AdaptiveDelayer) | Адаптивная задержка на основе блокировок | ✅ подходит | **9/10** | **Отлично подходит для приоритета №5 (антибот).** Простая реализация, умное поведение. То же, что "мониторинг блокировок" у других ИИ. |
| 8 | Single-file executable (PyInstaller) | .exe файл для Windows | ⚠️ подходит с доработками | **4/10** | **Упрощает запуск для конечных пользователей, но:** конфликтует с хостингом (не нужен .exe на сервере). Playwright в .exe = огромный размер (~500 MB+). |
| 9 | Скрипт авто-установки (install.bat/sh) | Один клик для установки зависимостей | ✅ подходит | **8/10** | **Хорошо для приоритета №1 (простота).** Простая реализация, помогает новым пользователям. |
| 10 | Web-интерфейс на Streamlit | Browser-based UI | ❌ не подходит | **4/10** | **То же, что у Grok.** Конфликтует с простотой для локального ПК. |
| 11 | Telegram bot интерфейс | Запуск парсинга через бота | ❌ не подходит | **3/10** | **Креативно, но выходит за рамки проекта.** Telegram bot требует постоянного запуска, хостинга бота. Усложнение. |
| 12 | Serverless с Docker | VPS, PythonAnywhere, Railway.app, Fly.io | ✅ подходит | **8/10** | **Хорошая идея для приоритета №2 (хостинг).** Railway/Fly = простой деплой. Но нужен HTTP-only режим (без Playwright). |

**Общая оценка блока 4.1:** Много практичных идей. Сильные: №1 (режимы), №7 (adaptive delay), №9 (скрипт установки), №12 (serverless).

#### Deepseek ответ 4.2 (задание для Cursor)

| № | Идея | Кратко | Применимость | Оценка /10 | Аргументация |
|---|------|--------|--------------|------------|--------------|
| 1 | Удалить curl_cffi, использовать только Playwright | Полный переход на Playwright | ❌ не подходит | **2/10** | **Конфликтует с целью "убрать Playwright из runtime".** Playwright тяжёлый для хостинга. Лучше наоборот: HTTP-only. |
| 2 | BrowserPool для управления браузерами | Класс для пула Playwright браузеров | ⚠️ подходит с доработками | **6/10** | **То же, что в 4.1.** Хорошо, но RAM-hungry. |
| 3 | Три режима (fast/server/debug) | --mode аргумент в CLI | ✅ подходит | **9/10** | **То же, что в 4.1.** Отлично. |
| 4 | Docker с Selenium base image | FROM selenium/standalone-chrome | ⚠️ подходит с доработками | **5/10** | **Selenium тяжелее Playwright.** Лучше python:3.12-slim без браузеров (для HTTP-only). |
| 5 | Makefile для всех платформ | make install, make run | ✅ подходит | **8/10** | **Хорошо для простоты.** Единый интерфейс для разных ОС. |

---

### ИИ №5: Perplexity (2 ответа) - Архитектурные улучшения

#### Perplexity ответ 5.1 (детальный анализ проблем)

| № | Идея | Кратко | Применимость | Оценка /10 | Аргументация |
|---|------|--------|--------------|------------|--------------|
| 1 | Сделать Playwright первичным каналом | Playwright primary, curl_cffi secondary | ⚠️ подходит с доработками | **4/10** | **Конфликтует с целью "HTTP-only".** Логи показывают: Playwright работает 100%, но медленно (5-10 сек). Это решение для краткосрочного фикса, но долгосрочно плохо для хостинга. |
| 2 | Подключить прокси-пул для Playwright | Резидентные прокси + IP rotation | ⚠️ подходит с доработками | **5/10** | **То же, что раньше.** Прокси = деньги + сложность. |
| 3 | Профили конфигурации через .env | OZON_PROFILE=dev/prod/aggressive | ✅ подходит | **9/10** | **Отлично для приоритета №4 (поддерживаемость).** Чистая архитектура, легко расширяемая. |
| 4 | Адаптивный throttling (PID-контроллер) | Авто-регулировка delay на основе 403 | ✅ подходит | **9/10** | **То же, что AdaptiveDelayer у Deepseek.** Умное решение для антибота. |
| 5 | Один браузер — много страниц (Playwright) | Переиспользование browser instance | ✅ подходит | **8/10** | **Хорошо для оптимизации Playwright fallback.** Но конфликтует с HTTP-only целью. |
| 6 | Persistent context для Playwright | Сохранение профиля браузера на диск | ✅ подходит | **7/10** | **Хорошая идея для антибота.** Но опять же — конфликтует с HTTP-only. |
| 7 | Параллельная загрузка страниц в одном браузере | 3-4 page в одном context | ⚠️ подходит с доработками | **6/10** | **Интересная оптимизация, но сложная реализация.** RAM потребление высокое. |
| 8 | Cloud Playwright / browserless (микросервис) | Playwright как отдельный сервис | ⚠️ подходит с доработками | **6/10** | **То же, что у Grok.** Дополнительные расходы. |
| 9 | Разделить режимы: MY_ACCOUNT vs FOREIGN_SELLER | Чёткая логика для Seller API | ✅ подходит | **10/10** | **Критически важно.** Решает проблему 0 товаров из Seller API. Логи показывают: товары НЕ принадлежат аккаунту. Нужна проверка и пропуск Seller API для чужих продавцов. |
| 10 | Авто-диагностика Seller API | Тестовый запрос перед основным парсингом | ✅ подходит | **9/10** | **Отлично для надёжности.** Быстро покажет, работает ли Seller API. |
| 11 | Централизованная конфигурация (Config dataclass) | OzonConfig класс для всех параметров | ✅ подходит | **9/10** | **Отлично для поддерживаемости.** Чистая архитектура, упрощает тестирование. |
| 12 | Feature-flags (FEATURE_USE_PROXY_ROTATION) | Включение/выключение фич без изменения кода | ✅ подходит | **8/10** | **Хорошо для A/B тестирования.** Но может усложнить конфигурацию. |

**Общая оценка блока 5.1:** Очень сильный блок. Особенно идеи №9, №10, №11 — архитектурно правильные и решают реальные проблемы.

#### Perplexity ответ 5.2 (простота и хостинг)

| № | Идея | Кратко | Применимость | Оценка /10 | Аргументация |
|---|------|--------|--------------|------------|--------------|
| 1 | Режимы работы: LIGHT/FULL/HEADLESS_REMOTE | HTTP-only vs Playwright vs Server | ✅ подходит | **10/10** | **Идеально попадает в приоритеты.** LIGHT = HTTP-only для хостинга, FULL = Playwright для dev. Это то, что нужно. |
| 2 | Минимизировать зависимости (requirements-core/playwright) | Разделить requirements.txt | ✅ подходит | **10/10** | **Критически важно для хостинга.** requirements-core без Playwright = быстрый pip install, лёгкий Docker. |
| 3 | Docker с Playwright образом как база | mcr.microsoft.com/playwright/python | ⚠️ подходит с доработками | **5/10** | **Конфликтует с LIGHT режимом.** Если базовый образ с Playwright, то Docker будет тяжёлым даже для HTTP-only. Лучше python:3.12-slim + опциональный Playwright. |
| 4 | VPS / Docker хостинг (Kamatera, Hostinger) | Рекомендации по хостингу | ✅ подходит | **7/10** | **Хорошие рекомендации, но общие.** Railway/Fly лучше для простоты. |
| 5 | Ограничение ресурсов Docker (CPU/RAM limits) | docker --memory=1g --cpus=1 | ✅ подходит | **8/10** | **Хорошо для стабильности на слабых ПК.** Простая настройка. |
| 6 | Авто-выбор режима (если Playwright нет → LIGHT) | Fallback на HTTP-only если нет браузера | ✅ подходит | **9/10** | **Отлично для UX.** Парсер всегда запустится, даже без Playwright. |
| 7 | Преднастроенный docker-compose для cron | Периодический запуск через Docker | ✅ подходит | **8/10** | **Хорошо для автоматизации на хостинге.** Простая настройка. |

**Общая оценка блока 5.2:** Самый сильный блок по соответствию приоритетам. Идеи №1 и №2 — это ключевые для успеха проекта.

---

## 2. Сводная таблица лучших идей

| Идея | ИИ-источник | Оценка /10 | Почему подходит |
|------|-------------|------------|-----------------|
| **Режимы LIGHT/FULL/HEADLESS_REMOTE** | Perplexity 5.2 | **10/10** | Идеально решает все приоритеты: простота (LIGHT для ПК), хостинг (HTTP-only), скорость (FULL для dev) |
| **Cookies-as-a-Service (локально → файл)** | ChatGPT Thinking | **10/10** | Убирает Playwright с хостинга, упрощает запуск |
| **Убрать Playwright из runtime (→ dev-tools)** | ChatGPT Thinking | **10/10** | Критично для хостинга: лёгкий Docker, быстрый деплой |
| **requirements-core.txt / requirements-playwright.txt** | Perplexity 5.2 | **10/10** | Минимальные зависимости для хостинга |
| **Режим MY_ACCOUNT vs FOREIGN_SELLER** | Perplexity 5.1 | **10/10** | Решает проблему 0 товаров из Seller API |
| **Профили конфигурации (OZON_PROFILE=dev/prod)** | Perplexity 5.1 | **9/10** | Чистая архитектура, легко расширяется |
| **Разделение на режимы Fast/Server/Debug** | Deepseek 4.1, ChatGPT Thinking | **9/10** | То же, что LIGHT/FULL, но с другими названиями |
| **AdaptiveDelayer / PID-контроллер для задержек** | Deepseek 4.1, Perplexity 5.1 | **9/10** | Умная борьба с антиботом без ручной настройки |
| **Config dataclass для централизованных настроек** | Perplexity 5.1 | **9/10** | Упрощает код, тестирование, расширение |
| **Dockerization (HTTP-only образ)** | Grok 3.1, Deepseek 4.1 | **9/10** | Критично для хостинга, но нужен slim образ |
| **Авто-диагностика Seller API** | Perplexity 5.1 | **9/10** | Быстро показывает проблему, не тратит время |
| **Авто-выбор режима (нет Playwright → LIGHT)** | Perplexity 5.2 | **9/10** | Парсер всегда запустится, UX улучшается |
| **Скрипт авто-установки (install.sh/bat)** | Deepseek 4.1 | **8/10** | Упрощает первый запуск для новичков |
| **asyncio.gather вместо семафора** | ChatGPT Research, Grok 3.2 | **8/10** | Чище код, потенциально быстрее |
| **Переиспользование Playwright browser (для dev)** | Perplexity 5.1, Grok 3.2 | **8/10** | Ускоряет fallback, но только для dev |
| **Мониторинг блокировок + alerting** | ChatGPT Research, Grok 3.2 | **8/10** | Хорошо для production, но усложняет настройку |
| **Кэширование cookies на диск** | ChatGPT Thinking, ChatGPT Research | **8/10** | То же, что Cookies-as-a-Service |
| **Makefile для кросс-платформенных команд** | Deepseek 4.2 | **8/10** | Упрощает команды: make install, make run |
| **Кэш страниц каталога (.cache/)** | ChatGPT Thinking | **7/10** | Хорошо для dev, но нужна инвалидация |
| **Serverless (Cloud Run, Railway, Fly.io)** | Grok 3.1, Deepseek 4.1 | **7-8/10** | Отлично для хостинга, если HTTP-only |

---

## 3. Идеи, которые не стоит применять

| Идея | ИИ-источник | Почему НЕ подходит |
|------|-------------|-------------------|
| **Celery/Ray для распределенной обработки** | Grok 3.1 | Enterprise overkill. Требует Redis/RabbitMQ. Для 500 товаров не нужно. Конфликтует с простотой. |
| **GPU-accelerated парсинг с Dask** | Grok 3.1 | Абсурд. Парсинг JSON не требует GPU. Время парсинга = 2% от общего. |
| **ML для предсказания seller_price** | Grok 3.2 | Ненадёжно. Нет данных для обучения. Лучше признать отсутствие данных. |
| **AI для предсказания блокировок** | Grok 3.2 | Антибот Ozon непредсказуем. Модель будет бесполезной. Enterprise overkill. |
| **Kubernetes для хостинга** | Grok 3.1 | Overkill. Для одного парсера не нужно. Конфликтует с простотой. |
| **Telegram bot интерфейс** | Deepseek 4.1 | Выходит за рамки проекта. Требует постоянного хостинга бота. |
| **Streamlit/GUI** | Grok 3.1, Deepseek 4.1 | Конфликтует с простотой запуска на ПК. Требует веб-сервер. |
| **Официальные API вместо парсинга** | ChatGPT Research | Нереалистично. Ozon не даст больше API для конкурентного анализа. |
| **Ротация прокси (для локального ПК)** | Все | Дорого ($50+/мес), сложно настраивать, точка отказа. Для хостинга — возможно. |
| **Удалить curl_cffi, только Playwright** | Deepseek 4.2 | Конфликтует с HTTP-only целью. Playwright тяжёлый для хостинга. |
| **PyInstaller .exe** | Deepseek 4.1 | Playwright в .exe = ~500 MB. Конфликтует с хостингом. |
| **orjson вместо json** | ChatGPT Research | Микрооптимизация (парсинг = 2% времени). Даже 10x ускорение даст +0.2%. |

---

## 4. Мои дополнительные идеи

### Идея №1: "Гибридный режим HTTP → Fallback на облачный браузер"
**Проблема:** Playwright на сервере = тяжело. Облачные браузеры (Browserless.io) = дорого.  
**Решение:** HTTP-only (curl_cffi/httpx) + fallback на **бесплатный облачный инструмент** типа **ZenRows Free Tier** (1000 запросов/мес бесплатно) или **ScraperAPI Free Tier** (5000 запросов/мес).  
**Преимущества:** Хостинг остаётся лёгким (HTTP-only), но есть страховка от антибота. Бесплатный тир покрывает ~20-40 парсингов продавца.  
**Оценка:** **8/10** — хороший баланс между простотой и надёжностью.

### Идея №2: "Интеллектуальный выбор стратегии на основе истории"
**Проблема:** Сейчас парсер всегда пробует curl_cffi → 403 → Playwright. Это предсказуемо.  
**Решение:** Сохранять статистику по продавцам: `seller_176640_stats.json` → `{"last_success": "playwright", "403_rate": 1.0}`. При следующем запуске для этого продавца сразу использовать Playwright, пропуская curl_cffi.  
**Преимущества:** Ускорение на ~1-2 сек на страницу для "сложных" продавцов.  
**Оценка:** **7/10** — простая оптимизация, но экономия времени небольшая.

### Идея №3: "Готовый Railway/Fly.io template"
**Проблема:** Инструкции по хостингу есть, но нет готового шаблона.  
**Решение:** Создать `railway.toml` + `fly.toml` + `Dockerfile.railway` в репозитории. Пользователь делает: `git clone → railway up` — и парсер работает.  
**Преимущества:** Максимальная простота хостинга. Railway/Fly определяют Python проект автоматически.  
**Оценка:** **9/10** — сильно упрощает хостинг, соответствует приоритету №2.

### Идея №4: "Health check endpoint для мониторинга"
**Проблема:** Если парсер на хостинге "упал", мы узнаем об этом только при следующем запуске.  
**Решение:** Добавить опциональный FastAPI endpoint `/health` (только для server режима), который показывает: `{"status": "ok", "last_run": "2026-01-21T18:36:50", "last_products": 524}`.  
**Преимущества:** Мониторинг через UptimeRobot/Healthchecks.io (бесплатно).  
**Оценка:** **7/10** — хорошо для production, но усложняет код.

---

## 5. Предлагаемый план действий (roadmap)

### Приоритет 1: Критически важно (делать первым)

**1. Внедрить Cookies-as-a-Service** (2-3 часа)
- Создать `tools/get_cookies.py` — скрипт для получения cookies через Playwright (запуск локально)
- Сохранение cookies в `cookies/ozon_cookies.json`
- Загрузка cookies из файла в OzonCatalogAPI
- Обновление документации: "Шаг 1: получи cookies локально, Шаг 2: запусти парсер на сервере"

**2. Разделить requirements.txt** (30 минут)
- `requirements-core.txt`: curl_cffi, aiohttp, pandas, openpyxl, pydantic
- `requirements-playwright.txt`: playwright, playwright-stealth
- `requirements-dev.txt`: black, pytest, mypy

**3. Создать режимы LIGHT/FULL** (3-4 часа)
- `.env`: добавить `OZON_MODE=light|full`
- В `OzonCatalogAPI`: if mode == "light" → только curl_cffi (без fallback), if mode == "full" → curl_cffi + Playwright fallback
- Для LIGHT режима: логировать предупреждение "Playwright недоступен, риск блокировок"

**4. Фикс Seller API: режим MY_ACCOUNT vs FOREIGN_SELLER** (2 часа)
- `.env`: добавить `OZON_ACCOUNT_TYPE=my|foreign`
- Если `foreign` → пропускать Seller API полностью (не тратить 0.9 сек)
- Логировать: "Seller API пропущен (чужой продавец)"

**5. Создать Dockerfile для HTTP-only** (1-2 часа)
```dockerfile
FROM python:3.12-slim
WORKDIR /app
COPY requirements-core.txt .
RUN pip install --no-cache-dir -r requirements-core.txt
COPY . .
CMD ["python", "parse_ozon_sellers.py"]
```

**Ожидаемый результат после Приоритета 1:**
- Хостинг на Railway/Fly работает за 5 минут (git push → deploy)
- Docker образ: ~150 MB вместо ~1.5 GB
- Парсер работает на любом ПК без Playwright (если есть cookies)
- Seller API не тратит время на чужих продавцов

---

### Приоритет 2: Важно (делать вторым)

**6. Внедрить AdaptiveDelayer / PID-контроллер** (3-4 часа)
- Создать класс `AdaptiveDelayer` (как в идеях Deepseek)
- Логика: если 403 → увеличить delay на 50%, если 5 успешных запросов подряд → уменьшить delay на 20%
- Интеграция в `OzonCatalogAPI._fetch_page()`

**7. Централизованная конфигурация (Config dataclass)** (2-3 часа)
- Создать `src/config.py`:
```python
from dataclasses import dataclass
from enum import Enum

class Mode(Enum):
    LIGHT = "light"
    FULL = "full"

@dataclass
class OzonConfig:
    mode: Mode
    request_delay: float
    max_concurrent: int
    cookies_path: str
    account_type: str  # my/foreign
```
- Использовать во всех модулях вместо .env напрямую

**8. Авто-диагностика Seller API** (1 час)
- Перед основным запросом: тестовый запрос с 1 SKU
- Если 0 результатов → логировать + пропустить Seller API

**9. Скрипт авто-установки** (1 час)
- `install.sh` (Linux/Mac):
```bash
#!/bin/bash
python3 -m venv venv
source venv/bin/activate
pip install -r requirements-core.txt
echo "✅ Установка завершена (LIGHT режим)"
echo "Для FULL режима: pip install -r requirements-playwright.txt && playwright install chromium"
```
- `install.bat` (Windows) — аналогично

**10. Railway/Fly.io templates** (1-2 часа)
- Создать `railway.toml`, `fly.toml`, `Dockerfile.railway`
- README: секция "Deploy to Railway" с кнопкой

**Ожидаемый результат после Приоритета 2:**
- Парсер умный (адаптивные задержки)
- Конфигурация чистая (Config dataclass)
- Установка на новом ПК: 1 команда
- Хостинг: 1 кнопка

---

### Приоритет 3: Полезно (делать третьим)

**11. Кэш страниц каталога** (2 часа)
- Использовать `diskcache` (лучше чем TTLCache для persistence)
- `.cache/seller_{id}_page_{n}.json` с TTL=24 часа
- Опция в .env: `OZON_CACHE_ENABLED=true`

**12. Makefile для команд** (30 минут)
```makefile
install:
	pip install -r requirements-core.txt

install-dev:
	pip install -r requirements-core.txt -r requirements-playwright.txt
	playwright install chromium

run:
	python parse_ozon_sellers.py

docker-build:
	docker build -t ozon-parser .

docker-run:
	docker run --env-file .env ozon-parser
```

**13. Переиспользование Playwright browser (для FULL режима)** (2-3 часа)
- В `_fetch_page_via_playwright()`: не закрывать браузер между запросами
- Один browser instance на весь каталог
- Закрывать только в `__aexit__` контекст-менеджера

**14. Health check endpoint (опционально)** (2 часа)
- Добавить FastAPI (опциональная зависимость)
- Endpoint `/health` показывает статус последнего запуска
- Только для server режима

**Ожидаемый результат после Приоритета 3:**
- Повторные запуски быстрее (кэш)
- Команды единообразные (Makefile)
- Playwright fallback быстрее (~2-3 сек вместо 5-10 сек)
- Мониторинг работает (если нужен)

---

## Итоговое резюме

**Ключевые выводы:**

1. **Лучшие идеи:** Cookies-as-a-Service, режимы LIGHT/FULL, убирание Playwright из runtime, разделение requirements.txt
2. **Самые вредные идеи:** Celery/Ray, GPU-парсинг, ML-предсказания, Kubernetes
3. **Самый ценный ИИ-источник:** Perplexity 5.2 (идеально попадает в приоритеты)
4. **Главная проблема сейчас:** Playwright как runtime-зависимость убивает простоту хостинга

**Если делать только ТОП-3 изменения:**
1. **Cookies-as-a-Service** → Playwright только локально, на сервере HTTP-only
2. **Режимы LIGHT/FULL** → Один код для всех сценариев
3. **Dockerfile без Playwright** → Деплой на Railway/Fly за 5 минут

Это даст максимальный ROI при минимальных изменениях.

---

**Дата анализа:** 2026-01-21  
**Версия документа:** 1.0
